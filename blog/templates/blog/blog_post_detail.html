{% extends 'blog/base.html' %}
{% load markdown_extras %}

{% block title %}{{ blog_post.title }} - {{ profile_user.get_full_name|default:profile_user.username }}'s Blog{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <!-- Blog Post -->
            <article class="blog-post">
                <!-- Post Header -->
                <header class="post-header">
                    <h1 class="post-title">{{ blog_post.title }}</h1>
                    
                    <div class="post-meta">
                        <div class="author-info">
                            <i class="fa fa-user"></i>
                            <a href="{% url 'user_profile' profile_user.username %}" class="author-link">
                                {{ profile_user.get_full_name|default:profile_user.username }}
                            </a>
                        </div>
                        
                        <div class="post-date">
                            <i class="fa fa-calendar"></i>
                            {{ blog_post.published_date|date:"F d, Y \a\t g:i A" }}
                        </div>
                        
                        <div class="post-stats">
                            <span class="stat-item">
                                <i class="fa fa-eye"></i> {{ blog_post.view_count }} view{{ blog_post.view_count|pluralize }}
                            </span>
                            <span class="stat-item">
                                <i class="fa fa-comments"></i> {{ blog_post.get_comment_count }} comment{{ blog_post.get_comment_count|pluralize }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Author Actions -->
                    {% if user.is_authenticated and user == blog_post.author %}
                    <div class="post-actions">
                        <a href="{% url 'edit_blog_post' blog_post.id %}" class="btn btn-sm btn-warning">
                            <i class="fa fa-edit"></i> Edit Post
                        </a>
                        <a href="{% url 'delete_blog_post' blog_post.id %}" class="btn btn-sm btn-danger">
                            <i class="fa fa-trash"></i> Delete Post
                        </a>
                    </div>
                    {% endif %}
                </header>
                
                <!-- Post Content -->
                <div class="post-content">
                    {{ blog_post.content|obsidian_markdown }}
                </div>
                
                <!-- Post Footer -->
                <footer class="post-footer">
                    <div class="post-navigation">
                        <a href="{% url 'user_blog_list' profile_user.username %}" class="btn btn-default">
                            <i class="fa fa-arrow-left"></i> Back to {{ profile_user.get_full_name|default:profile_user.username }}'s Blog
                        </a>
                        <a href="{% url 'user_profile' profile_user.username %}" class="btn btn-default">
                            <i class="fa fa-user"></i> View Profile
                        </a>
                    </div>
                </footer>
            </article>
            
            <!-- Comments Section -->
            <section class="comments-section">
                <div class="comments-header">
                    <h3>
                        <i class="fa fa-comments"></i> 
                        Comments ({{ blog_post.get_comment_count }})
                    </h3>
                </div>
                
                <!-- Comment Form -->
                {% if can_comment %}
                <div class="comment-form-section">
                    <h4>Leave a Comment</h4>
                    <form method="post" class="comment-form">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="content">Your Comment:</label>
                            <textarea class="form-control" id="content" name="content" rows="4" 
                                      placeholder="Share your thoughts..." required></textarea>
                            <small class="help-block">
                                Comments support basic markdown formatting.
                            </small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-comment"></i> Post Comment
                            </button>
                        </div>
                    </form>
                </div>
                {% elif not user.is_authenticated %}
                <div class="comment-login-prompt">
                    <p class="text-muted">
                        <i class="fa fa-sign-in"></i>
                        <a href="{% url 'login' %}">Login</a> to leave a comment.
                    </p>
                </div>
                {% elif not blog_post.allow_comments %}
                <div class="comments-disabled">
                    <p class="text-muted">
                        <i class="fa fa-lock"></i>
                        Comments are disabled for this post.
                    </p>
                </div>
                {% endif %}
                
                <!-- Comments List -->
                {% if comments %}
                <div class="comments-list">
                    {% for comment in comments %}
                    <div class="comment" id="comment-{{ comment.id }}">
                        <div class="comment-header">
                            <div class="comment-author">
                                <i class="fa fa-user-circle"></i>
                                <strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong>
                            </div>
                            <div class="comment-date">
                                {{ comment.created_date|date:"M d, Y \a\t g:i A" }}
                            </div>
                            
                            <!-- Comment Actions -->
                            {% if user.is_authenticated and user == comment.author %}
                            <div class="comment-actions">
                                <a href="{% url 'delete_blog_comment' comment.id %}" 
                                   class="btn btn-xs btn-danger"
                                   onclick="return confirm('Are you sure you want to delete this comment?')">
                                    <i class="fa fa-trash"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="comment-content">
                            {{ comment.content|linebreaks }}
                        </div>
                        
                        <!-- Reply Form -->
                        {% if can_comment %}
                        <div class="comment-reply">
                            <button class="btn btn-xs btn-link reply-btn" 
                                    onclick="toggleReplyForm({{ comment.id }})">
                                <i class="fa fa-reply"></i> Reply
                            </button>
                            
                            <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                <form method="post" class="comment-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                    <div class="form-group">
                                        <textarea class="form-control" name="content" rows="3" 
                                                  placeholder="Write a reply..." required></textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-xs btn-primary">
                                            <i class="fa fa-reply"></i> Reply
                                        </button>
                                        <button type="button" class="btn btn-xs btn-default" 
                                                onclick="toggleReplyForm({{ comment.id }})">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Replies -->
                        {% if comment.replies.all %}
                        <div class="comment-replies">
                            {% for reply in comment.replies.all %}
                            {% if reply.is_approved %}
                            <div class="comment reply">
                                <div class="comment-header">
                                    <div class="comment-author">
                                        <i class="fa fa-user-circle"></i>
                                        <strong>{{ reply.author.get_full_name|default:reply.author.username }}</strong>
                                        <span class="reply-indicator">
                                            <i class="fa fa-reply"></i> replied
                                        </span>
                                    </div>
                                    <div class="comment-date">
                                        {{ reply.created_date|date:"M d, Y \a\t g:i A" }}
                                    </div>
                                    
                                    {% if user.is_authenticated and user == reply.author %}
                                    <div class="comment-actions">
                                        <a href="{% url 'delete_blog_comment' reply.id %}" 
                                           class="btn btn-xs btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this reply?')">
                                            <i class="fa fa-trash"></i>
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="comment-content">
                                    {{ reply.content|linebreaks }}
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-comments">
                    <p class="text-muted">
                        <i class="fa fa-comment-o"></i>
                        No comments yet. Be the first to share your thoughts!
                    </p>
                </div>
                {% endif %}
            </section>
        </div>
    </div>
</div>

<style>
.blog-post {
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #333;
    border-radius: 5px;
    padding: 30px;
    margin-bottom: 30px;
}

.post-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #333;
}

.post-title {
    color: #00ff00;
    font-size: 28px;
    margin-bottom: 20px;
    line-height: 1.3;
}

.post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
    color: #999;
    font-size: 14px;
}

.author-link {
    color: #00ff00;
    text-decoration: none;
}

.author-link:hover {
    color: #32cd32;
    text-decoration: none;
}

.post-stats .stat-item {
    margin-right: 15px;
}

.post-actions {
    margin-top: 15px;
}

.post-actions .btn {
    margin-right: 10px;
}

.post-content {
    color: #ccc;
    line-height: 1.8;
    font-size: 16px;
}

.post-content h1,
.post-content h2,
.post-content h3,
.post-content h4,
.post-content h5,
.post-content h6 {
    color: #00ff00;
    margin-top: 30px;
    margin-bottom: 15px;
}

.post-content p {
    margin-bottom: 15px;
}

.post-content code {
    background: rgba(0, 255, 0, 0.1);
    color: #00ff00;
    padding: 2px 5px;
    border-radius: 3px;
}

.post-content pre {
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid #333;
    padding: 15px;
    border-radius: 5px;
    overflow-x: auto;
}

/* Responsive Blog Images */
.post-content img,
.post-content .obsidian-image,
.post-content .blog-image {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid #333;
}

.post-content img:hover,
.post-content .obsidian-image:hover,
.post-content .blog-image:hover {
    transform: scale(1.02);
    transition: transform 0.3s ease;
    box-shadow: 0 6px 12px rgba(0, 255, 0, 0.2);
}

/* Ensure images don't break layout on mobile */
@media (max-width: 768px) {
    .post-content img,
    .post-content .obsidian-image,
    .post-content .blog-image {
        margin: 15px auto;
        max-width: 95%;
    }
}

.post-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #333;
}

.post-navigation .btn {
    margin-right: 10px;
}

.comments-section {
    margin-top: 40px;
}

.comments-header h3 {
    color: #00ff00;
    margin-bottom: 25px;
}

.comment-form-section {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #333;
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 30px;
}

.comment-form-section h4 {
    color: #00ff00;
    margin-bottom: 15px;
}

.comment {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #333;
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 20px;
}

.comment.reply {
    margin-left: 40px;
    margin-top: 15px;
    background: rgba(0, 0, 0, 0.4);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.comment-author {
    color: #00ff00;
    font-weight: bold;
}

.comment-date {
    color: #999;
    font-size: 12px;
}

.comment-content {
    color: #ccc;
    line-height: 1.6;
}

.comment-reply {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #444;
}

.reply-form {
    margin-top: 10px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 5px;
}

.reply-indicator {
    color: #999;
    font-weight: normal;
    font-size: 12px;
}

.comment-login-prompt,
.comments-disabled,
.no-comments {
    text-align: center;
    padding: 30px;
    color: #999;
}

@media (max-width: 768px) {
    .post-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .comment.reply {
        margin-left: 20px;
    }
}
</style>

<script>
function toggleReplyForm(commentId) {
    const replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm.style.display === 'none' || replyForm.style.display === '') {
        replyForm.style.display = 'block';
        replyForm.querySelector('textarea').focus();
    } else {
        replyForm.style.display = 'none';
    }
}
</script>
{% endblock %}