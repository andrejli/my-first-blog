{% extends 'blog/base.html' %}
{% load static %}
{% load course_extras %}

{% block title %}{{ lesson.title }} - {{ course.title }} - FORTIS AURIS LMS{% endblock %}

{% block content %}

    <div class="content container">
        <div class="row">
            <div class="col-md-9">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <nav class="breadcrumb">
                        <a href="{% url 'course_list' %}">Courses</a> > 
                        <a href="{% url 'course_detail' course.id %}">{{ course.title }}</a> > 
                        <span>Lesson {{ lesson_number }}</span>
                    </nav>
                    
                    <h2>{{ lesson.title }}</h2>
                    <p class="lesson-meta">
                        <strong>Course:</strong> {{ course.title }} ({{ course.course_code }}) | 
                        <strong>Lesson:</strong> {{ lesson_number }} of {{ total_lessons }}
                    </p>
                </div>

                <!-- Instructor Preview Banner -->
                {% if is_instructor_preview %}
                <div class="alert alert-warning" style="background-color: #2a1a00; border-color: #ffc107; color: #ffc107;">
                    <h4><i class="glyphicon glyphicon-eye-open"></i> Instructor Preview Mode</h4>
                    <p><strong>Course Status:</strong> {{ course.status|title }} | 
                       <strong>Lesson Status:</strong> {{ lesson.is_published|yesno:"Published,Draft" }}</p>
                    <p><small>This is how the lesson appears to students. Only you can see this preview.</small></p>
                </div>
                {% endif %}

                <!-- Progress Indicator -->
                <div class="lesson-progress">
                    <!-- CLI Browser Progress Summary -->
                    <noscript>
                    <div style="background-color: #fff3cd; padding: 10px; margin: 10px 0; border: 1px solid #ffeaa7; border-radius: 4px;">
                        <strong>Course Progress:</strong> Lesson {{ lesson_number }} of {{ total_lessons }} 
                        ({{ lesson_number|mul:100|div:total_lessons|floatformat:0 }}% through course)
                    </div>
                    </noscript>
                    
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ lesson_number|mul:100|div:total_lessons }}%">
                            {{ lesson_number }} / {{ total_lessons }}
                        </div>
                    </div>
                </div>

                <!-- Lesson Content -->
                <div class="lesson-content">
                    <!-- Video if available -->
                    {% if lesson.video_url %}
                    <div class="lesson-video">
                        <h4><i class="glyphicon glyphicon-play-circle"></i> Video Content</h4>
                        
                        <!-- CLI Browser Video Alternative -->
                        <noscript>
                        <div style="background-color: #f8d7da; padding: 10px; margin: 10px 0; border: 1px solid #f5c6cb; border-radius: 4px;">
                            <strong>ðŸŽ¥ Video Content Available:</strong><br>
                            This lesson includes video content that cannot be displayed in CLI browsers.<br>
                            Video URL: <a href="{{ lesson.video_url }}" target="_blank">{{ lesson.video_url }}</a><br>
                            <em>Tip: Copy the URL and open it in a regular browser to view the video.</em>
                        </div>
                        </noscript>
                        
                        <div class="video-container">
                            {% if 'youtube.com' in lesson.video_url or 'youtu.be' in lesson.video_url %}
                                <!-- YouTube embed -->
                                {% with lesson.video_url|cut:"https://www.youtube.com/watch?v="|cut:"https://youtu.be/" as video_id %}
                                <iframe width="100%" height="400" 
                                        src="https://www.youtube.com/embed/{{ video_id }}" 
                                        frameborder="0" allowfullscreen>
                                </iframe>
                                {% endwith %}
                            {% else %}
                                <!-- Generic link -->
                                <p><a href="{{ lesson.video_url }}" target="_blank" class="btn btn-primary">
                                    <i class="glyphicon glyphicon-play"></i> Watch Video
                                </a></p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Text Content -->
                    <div class="lesson-text">
                        <h4><i class="glyphicon glyphicon-file-text"></i> Lesson Content</h4>
                        <div class="content-body markdown-content">
                            {% load markdown_extras %}
                            {{ lesson.content|obsidian_markdown }}
                        </div>
                    </div>

                    <!-- Completion Status -->
                    <!-- Completion Status -->
                    {% if not is_instructor_preview %}
                    <div class="lesson-completion">
                        {% if progress.completed %}
                            <div class="alert alert-success">
                                <h4><i class="glyphicon glyphicon-ok-circle"></i> Lesson Completed!</h4>
                                <p>You completed this lesson on {{ progress.completion_date|date:"M d, Y at H:i" }}.</p>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <h4><i class="glyphicon glyphicon-info-sign"></i> Mark as Complete</h4>
                                <p>Have you finished this lesson? Mark it as complete to track your progress.</p>
                                <form method="post" action="{% url 'mark_lesson_complete' course.id lesson.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="glyphicon glyphicon-ok"></i> Mark as Complete
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- Instructor Preview Info -->
                    <div class="alert alert-info" style="background-color: #0a1a2a; border-color: #32cd32; color: #32cd32;">
                        <h4><i class="glyphicon glyphicon-cog"></i> Instructor Tools</h4>
                        <p>This lesson preview shows exactly what students will see.</p>
                        <div style="margin-top: 10px;">
                            <a href="{% url 'edit_lesson' lesson.id %}" class="btn btn-default">
                                <i class="glyphicon glyphicon-edit"></i> Edit Lesson
                            </a>
                            <a href="{% url 'instructor_course_detail' course.id %}" class="btn btn-info">
                                <i class="glyphicon glyphicon-list"></i> Back to Course Management
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Navigation -->
                <div class="lesson-navigation">
                    <div class="row">
                        <div class="col-sm-6">
                            {% if prev_lesson %}
                                <a href="{% url 'lesson_detail' course.id prev_lesson.id %}" class="btn btn-default">
                                    <i class="glyphicon glyphicon-chevron-left"></i> Previous: {{ prev_lesson.title|truncatechars:30 }}
                                </a>
                            {% endif %}
                        </div>
                        <div class="col-sm-6 text-right">
                            {% if next_lesson %}
                                <a href="{% url 'lesson_detail' course.id next_lesson.id %}" class="btn btn-primary">
                                    Next: {{ next_lesson.title|truncatechars:30 }} <i class="glyphicon glyphicon-chevron-right"></i>
                                </a>
                            {% else %}
                                <a href="{% url 'course_detail' course.id %}" class="btn btn-success">
                                    <i class="glyphicon glyphicon-list"></i> Course Complete!
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="sidebar">
                    <!-- Lesson Info -->
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Lesson Info</h4>
                        </div>
                        <div class="panel-body">
                            <p><strong>Lesson:</strong> {{ lesson_number }} of {{ total_lessons }}</p>
                            <p><strong>Course:</strong> {{ course.course_code }}</p>
                            <p><strong>Created:</strong> {{ lesson.created_date|date:"M d, Y" }}</p>
                            {% if lesson.video_url %}
                                <p><i class="glyphicon glyphicon-play-circle text-success"></i> Video included</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Quick Actions</h4>
                        </div>
                        <div class="panel-body">
                            <a href="{% url 'course_detail' course.id %}" class="btn btn-default btn-block">
                                <i class="glyphicon glyphicon-list"></i> All Lessons
                            </a>
                            {% if not progress.completed %}
                                <form method="post" action="{% url 'mark_lesson_complete' course.id lesson.id %}" style="margin-top: 10px;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-block">
                                        <i class="glyphicon glyphicon-ok"></i> Complete Lesson
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}