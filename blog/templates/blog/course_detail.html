<!DOCTYPE html>
{% load static %}
{% load course_extras %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }} - LMS</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="{% static 'css/blog.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,0,1;wght@300;400;500;700&family=Ubuntu+Mono:ital,0,1;wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-header">
        <h1><a href="{% url 'course_list' %}">âš¡ Terminal LMS</a></h1>
        <div class="top-menu">
            {% if user.is_authenticated %}
                <span>user@lms:~$ {{ user.username }}</span>
                <a href="{% url 'course_list' %}" class="btn btn-default">courses</a>
            {% else %}
                <a href="/admin/" class="btn btn-default">login</a>
            {% endif %}
        </div>
    </div>

    <div class="content container">
        <div class="row">
            <div class="col-md-8">
                <!-- Course Header -->
                <div class="course-header">
                    <h2>{{ course.title }}</h2>
                    <p class="course-code"><strong>Course Code:</strong> {{ course.course_code }}</p>
                    <p class="lead">{{ course.description }}</p>
                </div>

                <!-- Course Info -->
                <div class="row course-info">
                    <div class="col-sm-3">
                        <strong>Instructor:</strong><br>
                        {{ course.instructor.get_full_name|default:course.instructor.username }}
                    </div>
                    <div class="col-sm-3">
                        <strong>Duration:</strong><br>
                        {{ course.duration_weeks }} week{% if course.duration_weeks != 1 %}s{% endif %}
                    </div>
                    <div class="col-sm-3">
                        <strong>Enrolled:</strong><br>
                        {{ course.get_enrolled_count }}/{{ course.max_students }} students
                    </div>
                    <div class="col-sm-3">
                        <strong>Published:</strong><br>
                        {{ course.published_date|date:"M d, Y" }}
                    </div>
                </div>

                <!-- Enrollment Status -->
                {% if user.is_authenticated %}
                    {% if is_enrolled %}
                        <div class="alert alert-success">
                            <h4><i class="glyphicon glyphicon-ok"></i> You are enrolled in this course!</h4>
                            {% if total_lessons > 0 %}
                                <p>Progress: {{ completed_lessons }}/{{ total_lessons }} lessons completed 
                                ({{ completed_lessons|floatformat:0 }}{% if total_lessons %}{{ ''|add:completed_lessons|mul:100|div:total_lessons|floatformat:0 }}%{% endif %})</p>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {% if total_lessons %}{{ completed_lessons|mul:100|div:total_lessons }}{% else %}0{% endif %}%">
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <h4>Ready to start learning?</h4>
                            <p>Enroll in this course to access all lessons and track your progress.</p>
                            <a href="{% url 'enroll_course' course.id %}" class="btn btn-success">
                                <i class="glyphicon glyphicon-plus"></i> Enroll Now
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <h4>Login Required</h4>
                        <p>Please <a href="/admin/">login</a> to enroll in this course and access lessons.</p>
                    </div>
                {% endif %}

                <!-- Course Prerequisites -->
                {% if course.prerequisites %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4>Prerequisites</h4>
                    </div>
                    <div class="panel-body">
                        {{ course.prerequisites|linebreaks }}
                    </div>
                </div>
                {% endif %}

                <!-- Course Lessons -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4>Course Content</h4>
                    </div>
                    <div class="panel-body">
                        {% if lessons %}
                            <div class="lesson-list">
                                {% for lesson in lessons %}
                                <div class="lesson-item">
                                    <div class="row">
                                        <div class="col-sm-1">
                                            {% if is_enrolled %}
                                                {% if user_progress|get_item:lesson.pk %}
                                                    <i class="glyphicon glyphicon-ok-circle text-success"></i>
                                                {% else %}
                                                    <i class="glyphicon glyphicon-record text-muted"></i>
                                                {% endif %}
                                            {% else %}
                                                <i class="glyphicon glyphicon-lock text-warning"></i>
                                            {% endif %}
                                        </div>
                                        <div class="col-sm-1">
                                            <span class="lesson-number">{{ lesson.order }}</span>
                                        </div>
                                        <div class="col-sm-8">
                                            {% if is_enrolled %}
                                                <a href="{% url 'lesson_detail' course.id lesson.id %}" class="lesson-link">
                                                    {{ lesson.title }}
                                                </a>
                                            {% else %}
                                                <span class="lesson-title-locked">{{ lesson.title }}</span>
                                            {% endif %}
                                            {% if lesson.video_url %}
                                                <small class="text-muted"><i class="glyphicon glyphicon-play-circle"></i> Video</small>
                                            {% endif %}
                                        </div>
                                        <div class="col-sm-2 text-right">
                                            {% if is_enrolled and user_progress|get_item:lesson.pk %}
                                                <small class="text-success">Completed</small>
                                            {% elif is_enrolled %}
                                                <small class="text-muted">Not started</small>
                                            {% else %}
                                                <small class="text-warning">Locked</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No lessons available yet. Check back soon!</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Course Assignments -->
                {% if user.is_authenticated and is_enrolled and assignments %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4><i class="glyphicon glyphicon-tasks"></i> Assignments</h4>
                    </div>
                    <div class="panel-body">
                        <div class="assignment-list">
                            {% for assignment in assignments %}
                            <div class="assignment-item panel panel-default">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h5><strong>{{ assignment.title }}</strong></h5>
                                            <p class="text-muted">{{ assignment.description|truncatewords:20 }}</p>
                                            
                                            <div class="assignment-meta">
                                                <span class="label label-info">{{ assignment.max_points }} points</span>
                                                
                                                {% if assignment.is_overdue %}
                                                    <span class="label label-danger">Overdue</span>
                                                {% else %}
                                                    <span class="label label-success">Open</span>
                                                {% endif %}
                                                
                                                {% with user_submissions|get_item:assignment.id as submission %}
                                                    {% if submission %}
                                                        {% if submission.status == 'submitted' %}
                                                            <span class="label label-warning">Submitted</span>
                                                        {% elif submission.status == 'graded' %}
                                                            <span class="label label-primary">Graded: {{ submission.grade }}/{{ assignment.max_points }}</span>
                                                        {% else %}
                                                            <span class="label label-default">Draft</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="label label-default">Not Started</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-right">
                                            <p><strong>Due:</strong><br>{{ assignment.due_date|date:"M d, Y" }}<br><small>{{ assignment.due_date|time:"H:i" }}</small></p>
                                            
                                            <div class="btn-group-vertical btn-group-sm">
                                                <a href="{% url 'assignment_detail' assignment.id %}" class="btn btn-primary">
                                                    <i class="glyphicon glyphicon-eye-open"></i> View Details
                                                </a>
                                                
                                                {% with user_submissions|get_item:assignment.id as submission %}
                                                    {% if submission and submission.status == 'draft' %}
                                                        <a href="{% url 'edit_submission' submission.id %}" class="btn btn-warning">
                                                            <i class="glyphicon glyphicon-edit"></i> Continue Draft
                                                        </a>
                                                    {% elif not submission and not assignment.is_overdue %}
                                                        <a href="{% url 'submit_assignment' assignment.id %}" class="btn btn-success">
                                                            <i class="glyphicon glyphicon-upload"></i> Start Assignment
                                                        </a>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="text-center">
                            <a href="{% url 'student_assignments' course.id %}" class="btn btn-default">
                                <i class="glyphicon glyphicon-list"></i> View All Assignments
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <div class="sidebar">
                    <!-- Quick Actions -->
                    {% if user.is_authenticated and is_enrolled %}
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Quick Actions</h4>
                        </div>
                        <div class="panel-body">
                            {% if next_lesson %}
                                <a href="{% url 'lesson_detail' course.id next_lesson.id %}" class="btn btn-primary btn-block">
                                    Continue with Lesson {{ next_lesson.order }}: {{ next_lesson.title }}
                                </a>
                            {% elif is_enrolled %}
                                <div class="alert alert-success">
                                    <h4>ðŸŽ‰ Course Completed!</h4>
                                    <p>Congratulations! You have completed all lessons in this course.</p>
                                </div>
                            {% else %}
                                <p class="text-center">Enroll in this course to start learning!</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Course Stats -->
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>Course Stats</h4>
                        </div>
                        <div class="panel-body">
                            <p><strong>{{ lessons.count }}</strong> lesson{% if lessons.count != 1 %}s{% endif %}</p>
                            <p><strong>{{ course.get_enrolled_count }}</strong> student{% if course.get_enrolled_count != 1 %}s{% endif %} enrolled</p>
                            <p><strong>{{ course.duration_weeks }}</strong> week duration</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom filter for template -->
    {% load static %}
    <script>
        // Terminal-style cursor effect
        console.log("âš¡ Terminal LMS loaded successfully");
    </script>
</body>
</html>